<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proxy & Latency Tester</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Using Inter font */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Simple loading spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Custom class to make IP wrap */
        .ip-address-wrap {
            overflow-wrap: break-word;
            word-wrap: break-word;
            word-break: break-all;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen p-4 py-12">

    <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-xl mx-auto">
        <h1 class="text-3xl font-bold text-center mb-6 text-blue-400">Proxy Tester</h1>
        
        <!-- Current Test Section -->
        <div class="space-y-4">
            <!-- IP Address Section -->
            <div class="bg-gray-700 p-5 rounded-lg">
                <h2 class="text-sm font-semibold text-gray-400 mb-1">Your IP Address</h2>
                <div id="ip-address" class="text-2xl font-semibold h-9">
                    <div class="spinner w-6 h-6"></div>
                </div>
            </div>

            <!-- Latency Section -->
            <div class="bg-gray-700 p-5 rounded-lg">
                <h2 class="text-sm font-semibold text-gray-400 mb-1">Total Download</h2>
                <div id="latency" class="text-2xl font-semibold h-9">
                    <div class="spinner w-6 h-6"></div>
                </div>
            </div>

            <!-- TTFB Section -->
            <div class="bg-gray-700 p-5 rounded-lg">
                <h2 class="text-sm font-semibold text-gray-400 mb-1">Time to First Byte (TTFB)</h2>
                <div id="ttfb" class="text-2xl font-semibold h-9">
                    <div class="spinner w-6 h-6"></div>
                </div>
            </div>

            <!-- Location Section -->
            <div class="bg-gray-700 p-5 rounded-lg">
                <h2 class="text-sm font-semibold text-gray-400 mb-1">Location (Country)</h2>
                <div id="location-info" class="text-2xl font-semibold h-9">
                    <div class="spinner w-6 h-6"></div>
                </div>
            </div>
        </div>

        <!-- Button to re-run the test -->
        <button id="test-button" class="mt-8 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out disabled:opacity-50">
            Test Again
        </button>

        <!-- Results Log Section -->
        <div class="mt-10">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Results Log</h2>
                <span id="total-entries" class="text-gray-400 font-medium">Total: 0</span>
            </div>
            
            <!-- Log Header -->
            <div class="hidden md:grid grid-cols-4 gap-4 px-4 py-2 bg-gray-700 rounded-t-lg font-semibold text-sm text-gray-300">
                <div>IP Address</div>
                <div>Country</div>
                <div>TTFB (ms)</div>
                <div>Total (ms)</div>
            </div>
            <!-- Log Container -->
            <div id="log-container" class="space-y-2 md:space-y-0 max-h-96 overflow-y-auto">
                <!-- Log entries will be injected here -->
                <div id="log-loading" class="flex justify-center items-center p-8">
                    <div class="spinner w-8 h-8"></div>
                </div>
            </div>
            <!-- Clear Log Button -->
            <button id="clear-log-button" class="mt-4 w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out disabled:opacity-50">
                Clear Log
            </button>
            <p id="clear-log-status" class="text-center text-sm text-gray-400 mt-2"></p>
        </div>
    </div>

    <!-- Firebase and App Logic -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, setLogLevel, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Get DOM elements
        const ipElement = document.getElementById('ip-address');
        const latencyElement = document.getElementById('latency');
        const ttfbElement = document.getElementById('ttfb');
        const locationElement = document.getElementById('location-info');
        const testButton = document.getElementById('test-button');
        const logContainer = document.getElementById('log-container');
        const logLoading = document.getElementById('log-loading');
        const totalEntriesElement = document.getElementById('total-entries');
        const clearLogButton = document.getElementById('clear-log-button');
        const clearLogStatus = document.getElementById('clear-log-status');


        // --- Firebase Setup ---
        
        // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        // PASTE YOUR FIREBASE CONFIG OBJECT HERE
        // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
       const firebaseConfig = {
            apiKey: "AIzaSyC7hd3-m-teSAfANdeBZtNfnqPXuZrv7Q0",
            authDomain: "my-proxy-tester-5be81.firebaseapp.com",
            projectId: "my-proxy-tester-5be81",
            storageBucket: "my-proxy-tester-5be81.firebasestorage.app",
            messagingSenderId: "500995191438",
            appId: "1:500995191438:web:6c9d4711da2c3eaab08fdf",
            measurementId: "G-BH9XW3MHMJ"
        };
        // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        const collectionName = "proxy-tests";
        // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

        let db, auth, logsCollection;
        
        // setLogLevel('debug');

        try {
            if (firebaseConfig.apiKey === "PASTE_YOUR_API_KEY_HERE") {
                throw new Error("Firebase config is not set. Please edit the HTML file.");
            }

            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            logsCollection = collection(db, collectionName);

            await signInAnonymously(auth);
            console.log("Firebase Auth success.");

            runTest();
            setupLogListener();

        } catch (e) {
            console.error("Error initializing Firebase:", e);
            displayGlobalError(e.message || "Could not connect to database.");
            if (e.code === "auth/configuration-not-found") {
                logLoading.innerHTML = `<p class="text-red-400 text-center p-4"><b>Error:</b> Firebase Anonymous Auth is not enabled. Please enable it in your Firebase project's Authentication -> Sign-in method tab.</p>`;
            }
        }
        
        function displayGlobalError(message) {
            ipElement.textContent = 'Error';
            latencyElement.textContent = 'Error';
            ttfbElement.textContent = 'Error';
            locationElement.textContent = 'Error';
            if (logLoading.innerHTML.includes('spinner')) {
                 logLoading.innerHTML = `<p class="text-red-400 text-center p-4">${message}</p>`;
            }
        }

        // --- Log Display Logic ---
        function setupLogListener() {
            if (!logsCollection) return;

            onSnapshot(logsCollection, (snapshot) => {
                let results = [];
                snapshot.forEach((doc) => {
                    results.push({ id: doc.id, ...doc.data() });
                });

                // Sort results by TTFB (lowest first)
                results.sort((a, b) => a.ttfb - b.ttfb);

                logContainer.innerHTML = '';
                totalEntriesElement.textContent = `Total: ${results.length}`;

                if (results.length === 0) {
                    logContainer.innerHTML = '<p class="text-gray-400 text-center p-4">No results logged yet.</p>';
                    return;
                }

                results.forEach(renderLogEntry);

            }, (error) => {
                console.error("Error listening to logs:", error);
                logContainer.innerHTML = '<p class="text-red-400 text-center p-4">Error loading results.</p>';
                totalEntriesElement.textContent = `Total: 0`;
            });
        }

        function renderLogEntry(data) {
            const ttfb = data.ttfb || 0;
            const total = data.totalDownload || 0;
            const ip = data.ip || 'N/A';
            const country = data.country || 'N/A';

            let ttfbColor = 'text-green-400';
            if (ttfb > 500) ttfbColor = 'text-yellow-400';
            if (ttfb > 1000) ttfbColor = 'text-red-400';

            const entry = document.createElement('div');
            entry.className = 'grid grid-cols-2 md:grid-cols-4 gap-4 px-4 py-3 bg-gray-800 md:bg-transparent rounded-lg md:rounded-none border-b border-gray-700';
            
            entry.innerHTML = `
                <div class="md:hidden font-semibold text-gray-400 text-sm">IP</div>
                <div class="md:hidden font-semibold text-gray-400 text-sm">Country</div>
                <div class="font-mono ip-address-wrap" title="${ip}">${ip}</div>
                <div class="truncate" title="${country}">${country}</div>

                <div class="md:hidden font-semibold text-gray-400 text-sm">TTFB</div>
                <div class="md:hidden font-semibold text-gray-400 text-sm">Total</div>
                <div class="font-mono ${ttfbColor}">${ttfb} ms</div>
                <div class="font-mono text-gray-400">${total} ms</div>
            `;
            logContainer.appendChild(entry);
        }
        
        // --- Test Logic ---
        async function runTest() {
            if (!logsCollection) {
                console.log("runTest called, but Firestore is not ready.");
                return;
            }

            ipElement.innerHTML = '<div class="spinner w-6 h-6"></div>';
            latencyElement.innerHTML = '<div class="spinner w-6 h-6"></div>';
            ttfbElement.innerHTML = '<div class="spinner w-6 h-6"></div>';
            locationElement.innerHTML = '<div class="spinner w-6 h-6"></div>';
            testButton.disabled = true;
            testButton.textContent = 'Testing...';

            if (window.performance && window.performance.clearResourceTimings) {
                window.performance.clearResourceTimings();
            }
            
            const fetchUrl = `https://get.geojs.io/v1/ip/geo.json?_=${new Date().getTime()}`;
            let ip, country, ttfbMs, totalMs, latencyStr, ttfbStr;

            try {
                // --- Part 1: Fetch IP and Timings ---
                const startTime = performance.now();
                const response = await fetch(fetchUrl);
                const manualEndTime = performance.now(); 
                
                if (!response.ok) {
                    throw new Error(`Fetch failed: ${response.statusText}`);
                }
                const data = await response.json();
                
                if (!data || !data.ip) {
                    throw new Error('Invalid IP data');
                }
                
                ip = data.ip;
                country = data.country; 

                // --- Advanced Measurement ---
                ttfbMs = 0;
                totalMs = Math.round(manualEndTime - startTime);
                latencyStr = `${totalMs} ms`;
                ttfbStr = 'N/A';

                if (window.performance && window.performance.getEntriesByName) {
                    const entries = window.performance.getEntriesByName(fetchUrl);
                    if (entries.length > 0) {
                        const timing = entries[0];
                        totalMs = Math.round(timing.duration);
                        
                        if (timing.responseStart > 0 && timing.responseStart > timing.fetchStart) {
                           ttfbMs = Math.round(timing.responseStart - timing.fetchStart);
                           ttfbStr = `${ttfbMs} ms`;
                        }
                        latencyStr = `${totalMs} ms`;
                    }
                }
                
                // Update UI with current test results
                ipElement.textContent = ip;
                latencyElement.textContent = latencyStr;
                ttfbElement.textContent = ttfbStr;
                locationElement.textContent = country || 'N/A';

                // --- Part 2: Save to Firestore ---
                try {
                    await addDoc(logsCollection, {
                        ip: ip,
                        country: country || 'N/A',
                        ttfb: ttfbMs,
                        totalDownload: totalMs,
                        timestamp: serverTimestamp()
                    });
                    console.log("Test result saved to Firestore.");
                } catch (saveError) {
                    console.error("Error saving to Firestore:", saveError);
                    // Show save error on the UI
                    ipElement.textContent = 'Error: Save failed';
                    ipElement.classList.add('text-red-400');
                }

            } catch (error) {
                console.error("Error fetching IP/Location:", error);
                // Show fetch error on the UI
                ipElement.textContent = `Error: ${error.message}`;
                ipElement.classList.add('text-red-400');
                latencyElement.textContent = 'Error';
                ttfbElement.textContent = 'Error';
                locationElement.textContent = 'Error';
            } finally {
                // Re-enable button
                testButton.disabled = false;
                testButton.textContent = 'Test Again';
            }
        }
        
        // --- Clear Log Logic ---
        async function clearLog() {
            clearLogButton.disabled = true;
            clearLogStatus.textContent = "Clearing... this may take a moment.";
            console.log("Starting to clear log...");

            try {
                const querySnapshot = await getDocs(logsCollection);
                let deletePromises = [];
                
                querySnapshot.forEach((doc) => {
                    deletePromises.push(deleteDoc(doc.ref));
                });

                await Promise.all(deletePromises);
                
                console.log("Log cleared successfully.");
                clearLogStatus.textContent = "Log cleared successfully.";
            } catch (error) {
                console.error("Error clearing log:", error);
                clearLogStatus.textContent = "Error clearing log.";
            } finally {
                clearLogButton.disabled = false;
                // Status message will fade after 3 seconds
                setTimeout(() => { clearLogStatus.textContent = ""; }, 3000);
            }
        }

        // Add click listeners
        testButton.addEventListener('click', runTest);
        clearLogButton.addEventListener('click', clearLog);

    </script>
</body>
</html>
